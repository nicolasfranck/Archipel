var iip;var TargetDrag=new Class({Extends:Drag,initialize:function(){var b=Array.link(arguments,{options:Object.type,element:$defined});this.element=$(b.element);this.document=this.element.getDocument();this.setOptions(b.options||{});var a=$type(this.options.handle);this.handles=(a=="array"||a=="collection")?$$(this.options.handle):$(this.options.handle)||this.element;this.mouse={now:{},pos:{}};this.value={start:{},now:{}};this.selection=(Browser.Engine.trident)?"selectstart":"mousedown";this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),eventStop:$lambda(false)};this.attach();if(Browser.Engine.trident){this.handles.ondragstart=function(){return false}}},drag:function(a){if(this.options.preventDefault){a.preventDefault()}this.mouse.now=a.page;for(var b in this.options.modifiers){if(!this.options.modifiers[b]){continue}this.value.now[b]=this.mouse.now[b]-this.mouse.pos[b];if(b=="x"){if(iip.rgn_x-this.value.now[b]<0){this.value.now[b]=iip.rgn_x;this.out=true}if(iip.wid>iip.rgn_w){if(iip.rgn_x-this.value.now[b]>iip.wid-iip.rgn_w){this.value.now[b]=-(iip.wid-iip.rgn_w-iip.rgn_x);this.out=true}}else{this.value.now[b]=0;this.out=true}}if(b=="y"){if(iip.rgn_y-this.value.now[b]<0){this.value.now[b]=iip.rgn_y;this.out=true}if(iip.hei>iip.rgn_h){if(iip.rgn_y-this.value.now[b]>iip.hei-iip.rgn_h){this.value.now[b]=-(iip.hei-iip.rgn_h-iip.rgn_y);this.out=true}}else{this.value.now[b]=0;this.out=true}}if(this.options.grid[b]){this.value.now[b]-=(this.value.now[b]%this.options.grid[b])}if(this.options.style){this.element.setStyle(this.options.modifiers[b],this.value.now[b]+this.options.unit)}else{this.element[this.options.modifiers[b]]=this.value.now[b]}}this.fireEvent("drag",this.element)}});var IIP=new Class({initialize:function(a,b){this.controls=b.controls||null;this.source=a||alert("No element ID given to IIP constructor");this.server=b.server||"/fcgi-bin/iipsrv.fcgi";this.render=b.render||"random";this.images=new Array(b.image.length);b.image||alert("Image location not set in IIP constructor options");if($type(b.image)=="array"){for(i=0;i<b.image.length;i++){this.images[i]={src:b.image[i],sds:"0,90"}}}else{this.images=[{src:b.image,sds:"0,90"}]}this.credit=b.credit||null;this.scale=b.scale||null;if(b.zoom==0){this.initialZoom=0}else{this.initialZoom=b.zoom||1}this.showNavButtons=true;if(b.showNavButtons==false){this.showNavButtons=false}this.targetclick=b.targetclick||null;this.max_width=0;this.max_height=0;this.min_x=0;this.min_y=0;this.sds="0,90";this.contrast=1;this.opacity=0;this.wid=0;this.hei=0;this.rgn_x=0;this.rgn_y=0;this.rgn_w=this.wid;this.rgn_h=this.wid;this.xfit=0;this.yfit=0;this.navpos=[0,0];this.tileSize=[0,0];this.num_resolutions=0;this.res;this.refresher=null;this.nTilesLoaded=0;this.nTilesToLoad=0;window.addEvent("domready",function(){var c=document.getElementById(a).offsetHeight;var d=document.getElementById(a).offsetWidth;if(c&&d){this.load()}else{if(!c){alert("height of "+a+" is not set ("+c+")")}if(!d){alert("width of "+a+" is not set ("+d+")")}}}.bind(this))},requestImages:function(){if(this.refresher){$clear(this.refresher);this.refresher=null}$("target").setStyle("cursor","wait");this.loadGrid();this.refresher=this.refresh.periodical(500,this)},loadGrid:function(){var d=$(this.source).getPosition();$("target").getChildren().each(function(j){j.destroy()});$("target").setStyles({left:0,top:0});this.rgn_x=(this.rgn_x>0)?this.rgn_x:0;this.rgn_y=(this.rgn_y>0)?this.rgn_y:0;var b=Math.floor(this.rgn_x/this.tileSize[0]);var a=Math.floor(this.rgn_y/this.tileSize[1]);var C=this.rgn_w;if(this.wid<this.rgn_w){C=this.wid}var h=Math.ceil((C+this.rgn_x)/this.tileSize[0]-1);C=this.rgn_h;if(this.hei<this.rgn_h){C=this.hei}var f=Math.ceil((C+this.rgn_y)/this.tileSize[1]-1);var r=Math.ceil(this.wid/this.tileSize[0]);var B=Math.ceil(this.hei/this.tileSize[1]);var o=Math.floor(this.rgn_x%this.tileSize[0]);if(this.wid<this.rgn_w){o-=(this.rgn_w-this.wid)/2}var l=Math.floor(this.rgn_y%this.tileSize[1]);if(this.hei<this.rgn_h){l-=(this.rgn_h-this.hei)/2}var E;var A,z,x,t;var c,q;x=0;t=0;var w=b+Math.round((h-b)/2);var v=a+Math.round((f-a)/2);var D=new Array((h-b)*(f-a));var g=0;for(z=a;z<=f;z++){for(A=b;A<=h;A++){D[g]={};if(this.render=="spiral"){D[g].n=Math.abs(v-z)*Math.abs(v-z)+Math.abs(w-A)*Math.abs(w-A)}else{D[g].n=Math.random()}D[g].x=A;D[g].y=z;g++}}this.nTilesLoaded=0;this.nTilesToLoad=g*this.images.length;D.sort(function p(k,j){return k.n-j.n});for(var u=0;u<g;u++){var A=D[u].x;var z=D[u].y;x=A+(z*r);var t;for(t=0;t<this.images.length;t++){E=new Element("img",{"class":"layer"+t,styles:{left:(A-b)*this.tileSize[0]-o,top:(z-a)*this.tileSize[1]-l},events:{load:function(j){this.nTilesLoaded++;this.refreshLoadBar()}.bind(this),error:function(){this.src=this.src}}});var e=this.server+"?FIF="+this.images[t].src+"&cnt="+this.contrast+"&sds="+this.images[t].sds+"&jtl="+this.res+","+x;E.set("src",e);E.injectInside("target")}}if(this.images.length>1){var y="img.layer"+(t-1);$$(y).set("opacity",this.opacity)}},refresh:function(){var a=0;$("target").getChildren().each(function(b){if(b.width==0||b.height==0){b.src=b.src;a=1}});if(a==0){$clear(this.refresher);this.refresher=null}},key:function(a){var b=100;switch(a.code){case 37:this.scrollTo(-b,0);break;case 38:this.scrollTo(0,-b);break;case 39:this.scrollTo(b,0);break;case 40:this.scrollTo(0,b);break;case 107:if(!a.control){this.zoomIn()}break;case 109:if(!a.control){this.zoomOut()}break}},scrollNavigation:function(g){if(this.controls){var d=0;var b=0;var a=$("zone").getSize();var c=a.x;var f=a.y;if(g.event){var h=$("navwin").getPosition();d=g.event.clientX-h.x-c/2;b=g.event.clientY-h.y-f/2}else{d=g.offsetLeft;b=g.offsetTop-10;if((Math.abs(d-this.navpos[0])<3)&&(Math.abs(b-this.navpos[1])<3)){return}}if(d>(this.min_x-c)){d=this.min_x-c}if(b>(this.min_y-f)){b=this.min_y-f}if(d<0){d=0}if(b<0){b=0}this.rgn_x=Math.round(d*this.wid/this.min_x);this.rgn_y=Math.round(b*this.hei/this.min_y);this.requestImages();if(g.event){this.positionZone()}}},scroll:function(){var b=-$("target").offsetLeft;var a=-$("target").offsetTop;this.scrollTo(b,a)},checkBounds:function(c,b){var a=this.rgn_x+c;var d=this.rgn_y+b;if(a>this.wid-this.rgn_w){a=this.wid-this.rgn_w}if(d>this.hei-this.rgn_h){d=this.hei-this.rgn_h}if(a<0){a=0}if(d<0){d=0}this.rgn_x=a;this.rgn_y=d},scrollTo:function(b,a){if(b||a){if((Math.abs(b)<3)&&(Math.abs(a)<3)){return}this.checkBounds(b,a);this.requestImages();this.positionZone()}},zoom:function(b){var a=new Event(b);if(a.wheel){if(a.wheel>0){this.zoomIn()}else{if(a.wheel<0){this.zoomOut()}}}else{if(a.shift){this.zoomOut()}else{this.zoomIn()}}},zoomIn:function(){if((this.wid<=(this.max_width/2))&&(this.hei<=(this.max_height/2))){this.res++;this.wid=this.max_width;this.hei=this.max_height;for(var a=this.res;a<this.num_resolutions-1;a++){this.wid=Math.floor(this.wid/2);this.hei=Math.floor(this.hei/2)}if(this.xfit==1){this.rgn_x=this.wid/2-(this.rgn_w/2)}else{if(this.wid>this.rgn_w){this.rgn_x=2*this.rgn_x+this.rgn_w/2}}if(this.rgn_x>this.wid){this.rgn_x=this.wid-this.rgn_w}if(this.rgn_x<0){this.rgn_x=0}if(this.yfit==1){this.rgn_y=this.hei/2-(this.rgn_h/2)}else{if(this.hei>this.rgn_h){this.rgn_y=this.rgn_y*2+this.rgn_h/2}}if(this.rgn_y>this.hei){this.rgn_y=this.hei-this.rgn_h}if(this.rgn_y<0){this.rgn_y=0}this.requestImages();this.positionZone();if(this.scale){this.setScale()}}},zoomOut:function(){if((this.wid>this.rgn_w)||(this.hei>this.rgn_h)){this.res--;this.wid=this.max_width;this.hei=this.max_height;for(var a=this.res;a<this.num_resolutions-1;a++){this.wid=Math.floor(this.wid/2);this.hei=Math.floor(this.hei/2)}this.rgn_x=this.rgn_x/2-(this.rgn_w/4);if(this.rgn_x+this.rgn_w>this.wid){this.rgn_x=this.wid-this.rgn_w}if(this.rgn_x<0){this.xfit=1;this.rgn_x=0}else{this.xfit=0}this.rgn_y=this.rgn_y/2-(this.rgn_h/4);if(this.rgn_y+this.rgn_h>this.hei){this.rgn_y=this.hei-this.rgn_h}if(this.rgn_y<0){this.yfit=1;this.rgn_y=0}else{this.yfit=0}this.requestImages();this.positionZone();if(this.scale){this.setScale()}}},calculateMinSizes:function(){var d=this.max_width;var a=this.max_height;var e=100;var g=$(this.source).getSize();var c=g.x;var b=g.y;if(c>b){if(d>2*a){e=c/2}else{e=c/4}}else{e=b/4}var f=this.res;while(d>e){d=parseInt(d/2);a=parseInt(a/2);if(--f==1){break}}this.min_x=d;this.min_y=a;d=this.max_width;a=this.max_height;while(d>c&&a>b){d=parseInt(d/2);a=parseInt(a/2);this.res--}this.wid=d;this.hei=a;this.res--},createWindows:function(){var e=$(this.source).getSize();var b=e.x;var a=e.y;this.calculateMinSizes();this.createNavigationWindow();var d=new Element("div",{id:"target",morph:{transition:Fx.Transitions.Quad.easeInOut,onComplete:this.requestImages.bind(this)}});new TargetDrag(d,{onComplete:this.scroll.bind(this)});d.injectInside(this.source);d.addEvent("mousewheel",this.zoom.bind(this));d.addEvent("dblclick",this.zoom.bind(this));if(this.targetclick){d.addEvent("click",this.targetclick.bindWithEvent(this))}this.rgn_w=b;this.rgn_h=a;this.reCenter();window.addEvent("resize",function(){window.location=window.location});document.addEvent("keydown",this.key.bindWithEvent(this));if(this.credit){new Element("div",{id:"credit",html:this.credit}).injectInside(this.source)}if(this.scale){new Element("div",{id:"scale"}).injectInside(this.source)}for(var c=0;c<this.initialZoom;c++){this.zoomIn()}this.zoomOut();this.requestImages();this.positionZone()},createNavigationWindow:function(){if(this.controls){var e=this.min_y/this.min_x;this.min_x=100;var d=100*e;this.min_y=d;var c=new Element("div",{id:"navcontainer",styles:{width:this.min_x,height:10}});var g=new Element("div",{id:"navwin",styles:{width:this.min_x}});g.injectInside(c);var b=new Element("img",{id:"navigation",styles:{width:this.min_x},src:this.server+"?FIF="+this.images[0].src+"&SDS="+this.images[0].sds+"&CNT=1.0&WID="+this.min_x+"&QLT=50&CVT=jpeg"});b.injectInside(g);var a=new Element("div",{id:"zone",styles:{width:this.min_x/2,height:this.min_y/2,opacity:0.4},morph:{duration:500,transition:Fx.Transitions.Quad.easeInOut}});a.injectInside(g);var j=new Element("div",{id:"loadBarContainer",html:'<div id="loadBar"></div>',styles:{width:this.min_x-2},tween:{duration:1000,transition:Fx.Transitions.Sine.easeOut,link:"cancel"}});var f=new Element("div",{id:"navbuttons",width:"100px",html:'<img id="zoomIn" src="images/iip/zoomIn.png" title="zoom in"/><img id="zoomOut" title="zoom out" src="images/iip/zoomOut.png"/><img id="reset" title="reset" src="images/iip/reset.png"/><img title="fullscreen" src="images/iip/fullscreen.png" id="fullscreen" />'});f.injectInside(c);f.set("slide",{duration:300,transition:Fx.Transitions.Quad.easeInOut,mode:"vertical"});j.injectInside(c);c.injectInside(this.source);if(this.showNavButtons==false){f.slide("out")}if(Browser.Engine.trident){$$("div#navbuttons, div#navbuttons img").setStyle("opacity",0.75)}$("zoomIn").addEvent("click",this.zoomIn.bindWithEvent(this));$("zoomOut").addEvent("click",this.zoomOut.bindWithEvent(this));$("reset").addEvent("click",function(){window.location=window.location});$("fullscreen").addEvent("click",function(){window.open(window.location.href)});$("zone").makeDraggable({container:"navwin",onStart:function(){this.navpos=[$("zone").offsetLeft,$("zone").offsetTop-10]}.bind(this),onComplete:this.scrollNavigation.bindWithEvent(this)});$("navigation").addEvent("click",this.scrollNavigation.bindWithEvent(this));$("navigation").addEvent("mousewheel",this.zoom.bindWithEvent(this));$("zone").addEvent("mousewheel",this.zoom.bindWithEvent(this));$("zone").addEvent("dblclick",this.zoom.bindWithEvent(this))}},refreshLoadBar:function(){if(this.controls){var a=(this.nTilesLoaded/this.nTilesToLoad)*this.min_x;$("loadBar").setStyle("width",a);$("loadBar").set("html",Math.round(this.nTilesLoaded/this.nTilesToLoad*100)+"%");if($("loadBarContainer").style.opacity!=0.85){$("loadBarContainer").setStyle("opacity",0.85)}}if(this.nTilesLoaded==this.nTilesToLoad){$("target").setStyle("cursor","move");if(this.controls){$("loadBarContainer").fade("out")}}},setScale:function(){var b=1000*this.scale*this.wid/this.max_width;var a="1m";if(b>1000){b=b/100;a="1cm"}else{if(b>100){b=b/10;a="10cm"}}$("scale").set({styles:{width:b},html:a})},load:function(){new Request({method:"get",url:this.server,onComplete:function(d){var a=d||alert("No response from server "+this.server);var c=a.split("Max-size");if(!c[1]){alert("Unexpected response from server "+this.server)}var b=c[1].split(" ");this.max_width=parseInt(b[0].substring(1,b[0].length));this.max_height=parseInt(b[1]);c=a.split("Tile-size");b=c[1].split(" ");this.tileSize[0]=parseInt(b[0].substring(1,b[0].length));this.tileSize[1]=parseInt(b[1]);c=a.split("Resolution-number");this.num_resolutions=parseInt(c[1].substring(1,c[1].length));this.res=this.num_resolutions;this.createWindows()}.bind(this),onFailure:function(){alert("Unable to get image and tile sizes from server!")}}).send("FIF="+this.images[0].src+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number")},reCenter:function(){this.rgn_x=(this.wid-this.rgn_w)/2;this.rgn_y=(this.hei-this.rgn_h)/2},positionZone:function(){if(this.controls){var e=(this.rgn_x/this.wid)*(this.min_x);if(e>this.min_x){e=this.min_x}if(e<0){e=0}var b=(this.rgn_y/this.hei)*(this.min_y);if(b>this.min_y){b=this.min_y}if(b<0){b=0}var d=(this.rgn_w/this.wid)*(this.min_x);if(e+d>this.min_x){d=this.min_x-e}var a=(this.rgn_h/this.hei)*(this.min_y);if(a+b>this.min_y){a=this.min_y-b}if(d<this.min_x){this.xfit=0}else{this.xfit=1}if(a<this.min_y){this.yfit=0}else{this.yfit=1}var c=$("zone").offsetHeight-$("zone").clientHeight;$("zone").morph({left:e,top:b+10,width:d-c/2,height:a-c/2})}}});